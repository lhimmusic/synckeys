<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SyncKeys ‚Äî Ïã§ÏãúÍ∞Ñ ÏõêÍ≤© Ìï©Ï£º</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#08080e;--surface:#101018;--surface2:#181824;--border:#252535;--border2:#303050;--accent:#00e5ff;--accent2:#ff6b35;--green:#00ff88;--text:#dde0f0;--danger:#ff4466;}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans KR',sans-serif;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,229,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.025) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0;}
.wrap{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column;}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:rgba(8,8,14,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
.logo{font-family:'Space Mono',monospace;font-size:18px;font-weight:700;letter-spacing:3px;}
.logo .k{color:var(--accent);}.logo .s{color:var(--accent2);}
.app-ver{margin-left:10px;font-size:11px;color:#6b7396;letter-spacing:1px;}
.insta-badge{margin-left:10px;padding:3px 8px;border-radius:999px;border:1px solid #ff6b35;color:#111;text-decoration:none;font-family:'Space Mono',monospace;font-size:10px;letter-spacing:1px;background:#ff6b35;}
.insta-badge:hover{background:#ff814f;color:#111;}
.header-right{display:flex;gap:12px;align-items:center;}
.conn-status{display:flex;align-items:center;gap:8px;font-family:'Space Mono',monospace;font-size:11px;color:#556;}
.dot{width:8px;height:8px;border-radius:50%;background:#333;transition:all .4s;}
.dot.ok{background:var(--green);box-shadow:0 0 8px var(--green);}
.dot.err{background:var(--danger);}
.midi-badge{display:none;padding:3px 10px;border-radius:20px;font-family:'Space Mono',monospace;font-size:10px;border:1px solid var(--border);color:#556;transition:all .2s;}
.midi-badge.active{border-color:var(--green);color:var(--green);box-shadow:0 0 8px rgba(0,255,136,.3);}
.screen{display:none;}
.screen.active{display:block;}
#session{display:none;flex-direction:column;}
#session.active{display:flex;flex:1;min-height:0;}
#lobby{max-width:860px;margin:0 auto;padding:48px 20px;}
.hero{text-align:center;margin-bottom:40px;}
.hero h1{font-family:'Space Mono',monospace;font-size:clamp(28px,6vw,56px);line-height:1.1;margin-bottom:14px;letter-spacing:2px;}
.hero h1 .k{color:var(--accent);text-shadow:0 0 60px rgba(0,229,255,.35);}
.hero h1 .s{color:var(--accent2);text-shadow:0 0 60px rgba(255,107,53,.28);}
.hero p{color:#556088;font-size:14px;font-weight:300;}
.audio-greeting{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:1px solid var(--accent);border-radius:999px;background:rgba(0,229,255,.08);color:var(--accent);font-family:'Space Mono',monospace;font-size:12px;cursor:pointer;transition:all .2s;position:absolute;top:14px;left:50%;transform:translateX(-50%);z-index:5;}
.audio-greeting:hover{background:rgba(0,229,255,.14);box-shadow:0 0 18px rgba(0,229,255,.22);}
.server-banner{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;margin-bottom:28px;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-family:'Space Mono',monospace;font-size:12px;color:#556;transition:all .3s;}
.server-banner.ok{border-color:var(--green);color:var(--green);}
.server-banner.err{border-color:var(--danger);color:var(--danger);}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:600px){.grid2{grid-template-columns:1fr;}}
.lobby-piano-card{margin-bottom:20px;padding:14px 12px;}
.lobby-piano-title{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin:2px 8px 10px;}
.lobby-piano-scroll{height:220px;padding:10px 12px 0;overflow:hidden;display:flex;align-items:flex-start;justify-content:center;scrollbar-width:none;border:1px solid var(--border);border-radius:10px;background:#070710;position:relative;}
.lobby-piano-scroll::-webkit-scrollbar{height:6px;}
.lobby-piano-scroll::-webkit-scrollbar-track{background:#070710;}
.lobby-piano-scroll::-webkit-scrollbar-thumb{background:#252535;border-radius:3px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:26px;transition:border-color .25s;}
.card:hover{border-color:var(--border2);}
.card-title{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:20px;}
.field{margin-bottom:14px;}
.field label{display:block;font-size:10px;color:#556;letter-spacing:1px;text-transform:uppercase;font-family:'Space Mono',monospace;margin-bottom:5px;}
.field input,.field select{width:100%;padding:9px 13px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Space Mono',monospace;font-size:12px;outline:none;transition:border-color .2s;}
.field input:focus,.field select:focus{border-color:var(--accent);}
.colors{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;}
.cswatch{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .2s,border-color .2s;}
.cswatch:hover,.cswatch.sel{transform:scale(1.25);border-color:#fff;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:10px 22px;border:none;border-radius:8px;cursor:pointer;font-family:'Space Mono',monospace;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;transition:all .2s;}
.btn-primary{background:var(--accent);color:#000;box-shadow:0 0 18px rgba(0,229,255,.25);}
.btn-primary:hover{box-shadow:0 0 30px rgba(0,229,255,.5);transform:translateY(-1px);}
.btn-outline{background:transparent;color:var(--accent);border:1px solid var(--accent);}
.btn-outline:hover{background:rgba(0,229,255,.08);}
.btn-red{background:transparent;color:var(--danger);border:1px solid var(--danger);}
.btn-red:hover{background:rgba(255,68,102,.08);}
.btn-full{width:100%;margin-top:6px;}
.btn:disabled{opacity:.38;cursor:not-allowed;transform:none!important;box-shadow:none!important;}
.room-list{margin-top:24px;}
.room-list-title{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:#446;margin-bottom:12px;}
.room-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;margin-bottom:8px;background:var(--surface);border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:all .2s;}
.room-item:hover{border-color:var(--accent);background:rgba(0,229,255,.04);}
.room-item-name{font-weight:700;font-size:14px;margin-bottom:3px;}
.room-item-meta{font-family:'Space Mono',monospace;font-size:11px;color:#556;}
.room-badges{display:flex;gap:6px;}
.badge{padding:2px 9px;border-radius:20px;font-size:10px;font-family:'Space Mono',monospace;border:1px solid var(--border);}
.badge-lock{border-color:var(--accent2);color:var(--accent2);}
.badge-full{border-color:var(--danger);color:var(--danger);}
.no-rooms{text-align:center;padding:28px;color:#446;font-size:13px;}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:300;}
.modal-bg.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--accent);border-radius:16px;padding:30px;width:340px;box-shadow:0 0 60px rgba(0,229,255,.18);animation:popIn .25s ease;}
@keyframes popIn{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
.modal h3{font-family:'Space Mono',monospace;color:var(--accent);margin-bottom:18px;}
.modal-btns{display:flex;gap:10px;margin-top:16px;}
.sess-top{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px;flex-shrink:0;position:sticky;top:0;z-index:220;}
.sess-room-name{font-family:'Space Mono',monospace;font-size:15px;color:var(--accent);font-weight:700;}
.room-id-tag{display:none;font-family:'Space Mono',monospace;font-size:11px;padding:3px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;color:#556;cursor:pointer;user-select:all;transition:border-color .2s;}
.room-id-tag:hover{border-color:var(--accent);color:var(--accent);}
.sess-controls{display:flex;align-items:center;gap:10px;}
.vol-row{display:flex;align-items:center;gap:8px;font-family:'Space Mono',monospace;font-size:10px;color:#556;}
.vol-row input[type=range]{width:80px;accent-color:var(--accent);}
.players-bar{display:flex;gap:8px;padding:8px 20px;background:rgba(8,8,14,.6);border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center;justify-content:center;flex-shrink:0;}
.player-chip{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);font-size:12px;transition:border-color .2s;}
.player-chip.mine{cursor:pointer;border-style:dashed;}
.player-chip.mine:hover{border-color:var(--accent);}
.player-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.player-ping{font-family:'Space Mono',monospace;font-size:10px;color:var(--green);}
.room-link{background:none;border:none;padding:0;margin:0;color:inherit;font:inherit;cursor:pointer;text-align:left;}
.room-link:hover{color:var(--accent);}
.latency-panel{display:none;gap:16px;padding:6px 20px;background:rgba(8,8,14,.5);border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center;flex-shrink:0;}
.lat-item{display:flex;align-items:center;gap:7px;font-family:'Space Mono',monospace;font-size:10px;}
.lat-bar{width:56px;height:5px;background:#151525;border-radius:3px;overflow:hidden;}
.lat-fill{height:100%;border-radius:3px;transition:width .6s,background .6s;}
.lat-ms{min-width:38px;}
.sess-main{display:flex;flex:1;flex-direction:column;overflow:hidden;min-height:0;padding-top:12px;}
.piano-area{flex:0 0 290px;display:flex;flex-direction:column;min-height:0;background:#070710;}
.piano-toolbar{display:none;}
.scroll-hint{color:#334;font-size:10px;letter-spacing:1px;}
.oct-btn{width:28px;height:28px;border-radius:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:'Space Mono',monospace;}
.oct-btn:hover{border-color:var(--accent);color:var(--accent);}
.view-label{color:var(--accent);font-size:12px;min-width:50px;text-align:center;}
.piano-scroll{flex:1;overflow-x:auto;overflow-y:hidden;display:flex;align-items:flex-start;padding:6px 32px 0;scrollbar-width:thin;scrollbar-color:#252535 #070710;scroll-behavior:smooth;}
.piano-scroll::-webkit-scrollbar{height:6px;}
.piano-scroll::-webkit-scrollbar-track{background:#070710;}
.piano-scroll::-webkit-scrollbar-thumb{background:#252535;border-radius:3px;}
.piano-scroll::-webkit-scrollbar-thumb:hover{background:var(--accent);}
.keyboard{position:relative;flex-shrink:0;user-select:none;}
.wkey{height:200px;background:linear-gradient(180deg,#dde0f0 0%,#f0f0ff 60%,#e8e8f8 100%);border:1px solid #9090b0;border-radius:0 0 6px 6px;cursor:pointer;position:absolute;transition:background .05s;box-shadow:inset 0 -3px 5px rgba(0,0,0,.08),1px 0 3px rgba(0,0,0,.12);}
.wkey:hover{background:linear-gradient(180deg,#c8eeff 0%,#e0f8ff 100%);}
.wkey.pressed-local{box-shadow:inset 0 3px 10px rgba(0,0,0,.35);}
.wkey.pressed-remote{box-shadow:inset 0 3px 10px rgba(0,0,0,.35),0 0 18px rgba(255,255,255,.35)!important;}
.key-label{position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-family:'Space Mono',monospace;font-size:7px;color:#9090b8;pointer-events:none;white-space:nowrap;}
.bkey{height:124px;background:linear-gradient(180deg,#1c1c2e 0%,#2a2a42 80%,#1a1a2e 100%);border:1px solid #404060;border-top:none;border-radius:0 0 4px 4px;position:absolute;top:0;z-index:2;cursor:pointer;box-shadow:2px 5px 10px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.05);transition:background .05s;}
.bkey:hover{background:linear-gradient(180deg,#2a2a44 0%,#383856 100%);}
.bkey.pressed-local{box-shadow:inset 0 3px 8px rgba(0,0,0,.4);}
.bkey.pressed-remote{box-shadow:inset 0 3px 8px rgba(0,0,0,.4),0 0 14px rgba(255,255,255,.45)!important;}
.active-notes{display:none !important;}
#activeNotes{display:none !important;}
.note-tag{padding:1px 9px;border-radius:20px;font-family:'Space Mono',monospace;font-size:10px;border:1px solid;animation:noteIn .06s ease;}
@keyframes noteIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.chat-panel{display:flex;flex-direction:column;border-top:1px solid var(--border);background:var(--surface);flex:1 1 auto;min-height:140px;margin-top:0;}
.chat-msgs{flex:1;overflow-y:auto;padding:6px 16px;scrollbar-width:thin;scrollbar-color:#222 transparent;}
.chat-msg{font-size:12px;line-height:1.5;margin-bottom:2px;}
.chat-msg .cn{font-weight:700;font-family:'Space Mono',monospace;font-size:11px;}
.chat-row{display:flex;gap:8px;padding:5px 12px;border-top:1px solid var(--border);flex-shrink:0;}
.chat-row input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 12px;color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:12px;outline:none;}
.chat-row input:focus{border-color:var(--accent);}
.color-popover{position:fixed;z-index:400;background:var(--surface);border:1px solid var(--accent);border-radius:12px;padding:14px 16px;box-shadow:0 8px 32px rgba(0,0,0,.6),0 0 24px rgba(0,229,255,.2);display:none;flex-direction:column;gap:10px;min-width:196px;animation:popIn .18s ease;}
.color-popover.open{display:flex;}
.color-popover-title{font-family:'Space Mono',monospace;font-size:10px;color:#556;letter-spacing:1px;text-transform:uppercase;}
.color-popover-swatches{display:flex;gap:8px;flex-wrap:wrap;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface);border:1px solid var(--accent);border-radius:8px;padding:10px 20px;font-family:'Space Mono',monospace;font-size:12px;color:var(--accent);transition:transform .3s;z-index:500;white-space:nowrap;box-shadow:0 0 20px rgba(0,229,255,.15);pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.error{border-color:var(--danger);color:var(--danger);}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo"><span class="k">SYNC</span><span class="s">KEYS</span><span class="app-ver">v26</span><a class="insta-badge" href="https://www.instagram.com/lhimmusic" target="_blank" rel="noopener noreferrer">INSTAGRAM</a></div>
  <div class="header-right">
    <div class="midi-badge" id="midiBadge">NO MIDI</div>
    <div class="conn-status"><div class="dot" id="connDot"></div><span id="connLabel">Ïó∞Í≤∞ Ï§ë...</span></div>
  </div>
</header>

<div class="screen active" id="lobby">
  <div class="hero">
    <h1><span class="k">SYNC</span><span class="s">KEYS</span></h1>
    <p>Ïñ¥ÎîîÏÑúÎì† Ìï®Íªò Ïó∞Ï£ºÌïòÏÑ∏Ïöî</p>
  </div>
  <div class="server-banner" id="serverBanner">
    <div class="dot" id="bannerDot"></div><span id="bannerText">ÏÑúÎ≤ÑÏóê ÏûêÎèô Ïó∞Í≤∞ Ï§ë...</span>
  </div>
  <div class="card lobby-piano-card">
    <div class="lobby-piano-scroll" id="lobbyPianoScroll">
      <button class="audio-greeting" id="audioGreeting" onclick="unlockAudioFromGreeting()">Í±¥Î∞òÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ ÌÅ¥Î¶≠</button>
      <div class="keyboard" id="lobbyKeyboard"></div>
    </div>
  </div>
  <div class="grid2">
    <div class="card">
      <div class="card-title">üéπ Î∞© ÎßåÎì§Í∏∞</div>
      <div class="field"><label>Î∞© Ïù¥Î¶Ñ</label><input type="text" id="createName" placeholder="My Jam Room" maxlength="40"></div>
      <div class="field"><label>ÎπÑÎ∞ÄÎ≤àÌò∏ (ÏÑ†ÌÉù, Ïà´Ïûê 4ÏûêÎ¶¨)</label><input type="password" id="createPw" placeholder="Ïòà: 1234" inputmode="numeric" maxlength="4" pattern="[0-9]{4}" oninput="this.value=this.value.replace(/\\D/g,'').slice(0,4)"></div>
      <div class="field"><label>ÏµúÎåÄ Ïù∏Ïõê</label>
        <select id="createMax"><option value="2">2Î™Ö</option><option value="4" selected>4Î™Ö</option><option value="8">8Î™Ö</option><option value="16">16Î™Ö</option></select>
      </div>
      <div class="field"><label>ÎÇ¥ Ïù¥Î¶Ñ</label><input type="text" id="createPlayerName" placeholder="Musician" maxlength="20"></div>
      <div class="field"><label>ÎÇ¥ ÏÉâÏÉÅ</label><div class="colors" id="createColors"></div></div>
      <button class="btn btn-primary btn-full" onclick="createRoom()" id="btnCreate" disabled>Î∞© ÎßåÎì§Í∏∞</button>
    </div>
    <div class="card">
      <div class="card-title">üö™ Î∞© Ï∞∏Í∞Ä</div>
      <div class="field"><label>ÎÇ¥ Ïù¥Î¶Ñ</label><input type="text" id="joinPlayerName" placeholder="Musician" maxlength="20"></div>
      <div class="field"><label>ÎÇ¥ ÏÉâÏÉÅ</label><div class="colors" id="joinColors"></div></div>
      <div class="room-list">
        <div class="room-list-title">Ï†ÑÏ≤¥ Î∞© Î™©Î°ù (Í≥µÍ∞ú/ÎπÑÍ≥µÍ∞ú)</div>
        <div id="roomList"><div class="no-rooms">ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</div></div>
      </div>
      <button class="btn btn-outline btn-full" onclick="refreshRooms()" id="btnRefresh" disabled style="margin-top:12px">ÏÉàÎ°úÍ≥†Ïπ®</button>
    </div>
  </div>
</div>

<div class="screen" id="session">
  <div class="sess-top">
    <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
      <div class="sess-room-name" id="sessRoomName">Room</div>
      <div class="room-id-tag" id="sessRoomId" onclick="copyRoomId()">------</div>
    </div>
    <div class="sess-controls">
      <div class="vol-row">üîä<input type="range" id="volSlider" min="0" max="1" step="0.05" value="0.2" oninput="setVolume(this.value)"></div>
      <button class="btn btn-outline" onclick="resetAllNotes()">reset</button>
      <button class="btn btn-red" onclick="leaveRoom()">Î∞© ÎÇòÍ∞ÄÍ∏∞</button>
    </div>
  </div>
  <div class="players-bar" id="playersBar"></div>
  <div class="latency-panel" id="latencyPanel"></div>
  <div class="sess-main">
    <div class="piano-area">
      <div class="piano-scroll" id="pianoScroll">
        <div class="keyboard" id="keyboard"></div>
      </div>
    </div>
    <div class="active-notes" id="activeNotes"></div>
    <div class="chat-panel">
      <div class="chat-msgs" id="chatMsgs"></div>
      <div class="chat-row">
        <input type="text" id="chatInput" placeholder="Ï±ÑÌåÖ Î©îÏãúÏßÄ..." maxlength="200" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-outline" onclick="sendChat()" style="padding:6px 14px;font-size:11px">Ï†ÑÏÜ°</button>
      </div>
    </div>
  </div>
</div>
</div>

<div class="modal-bg" id="pwModal">
  <div class="modal">
    <h3>üîí ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•</h3>
    <div class="field"><label>Î∞© ÎπÑÎ∞ÄÎ≤àÌò∏ (Ïà´Ïûê 4ÏûêÎ¶¨)</label><input type="password" id="modalPw" inputmode="numeric" maxlength="4" pattern="[0-9]{4}" oninput="this.value=this.value.replace(/\\D/g,'').slice(0,4)" onkeydown="if(event.key==='Enter')confirmPw()"></div>
    <div class="modal-btns">
      <button class="btn btn-primary" style="flex:1" onclick="confirmPw()">Ï∞∏Í∞Ä</button>
      <button class="btn btn-red" onclick="closePwModal()">Ï∑®ÏÜå</button>
    </div>
  </div>
</div>

<div class="color-popover" id="colorPopover">
  <div class="color-popover-title">ÎÇ¥ ÏÉâÏÉÅ Î≥ÄÍ≤Ω ‚úèÔ∏è</div>
  <div class="color-popover-swatches" id="popoverSwatches"></div>
</div>
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG (Ï£ºÏÜå ÏûêÎèô Ïù∏Ïãù)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CLOUDTYPE_URL = location.origin.replace(/^http/, 'ws');

// STATE
let ws=null,myId=null,myColor='#00e5ff',myName='',currentRoomId=null,pendingJoinRoom=null;
let audioCtx=null,masterGain=null,volume=0.2;
let activeOsc=new Map(),remoteOsc=new Map();
let midiAccess=null,midiConnected=false;
let midiOutputs=[];
const recentOutboundMidi=new Map();
let pressedLocal=new Set(),pressedRemote=new Map(),pressedRemoteVisual=new Map();
let latencyMap=new Map(),playerMap=new Map(),pingInterval=null;
let roomListAutoTimer=null;
let midiAutoAttempted=false;
let mouseDragActive=false,dragCurrentNote=null;
let sustainPedalDown=false;
let heldLocalNotes=new Set();
let sustainedNotes=new Set();
let pendingNoteOns=new Map();
let audioGreetingDismissed=false;

const MIDI_MIN=21,MIDI_MAX=108;
const NOTE_NAMES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const IS_BLACK=[false,true,false,true,false,false,true,false,true,false,true,false];
const WKW=34,BKW=21,BKH=126,WKH=200;
const COLORS=['#00e5ff','#ff6b35','#00ff88','#a855f7','#ffcc00','#ff4466','#3b82f6','#ec4899','#84cc16'];
let createColorSel='#00e5ff',joinColorSel='#ff6b35';

window.addEventListener('load',()=>{
  buildColorPickers();
  buildKeyboard88();
  buildLobbyKeyboard88();
  autoConnect();
  buildPopoverSwatches();
  autoEnableMidi();
  updateAudioGreeting();
});

// ÏÇ¨Ïö©ÏûêÍ∞Ä ÌôîÎ©¥ÏùÑ ÌÅ¥Î¶≠Ìï† ÎïåÎßàÎã§ Ïò§ÎîîÏò§ ÏóîÏßÑ ÌôúÏÑ±Ìôî ÏãúÎèÑ (Î∏åÎùºÏö∞Ï†Ä Ï†ïÏ±Ö Ìï¥Í≤∞)
document.addEventListener('mousedown', () => {
  ensureAudioReady();
  autoEnableMidi();
}, { once: false });

function autoConnect(){
  updateBanner('connecting');
  tryConnect(CLOUDTYPE_URL);
}
function tryConnect(url){
  if(ws){try{ws.close();}catch{}ws=null;}
  try{ws=new WebSocket(url);}catch{updateBanner('err','ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•ò');return;}
  ws.onopen=()=>{
    updateBanner('ok','ÏÑúÎ≤Ñ Ïó∞Í≤∞Îê®');
    setConnStatus('ok');
    ['btnCreate','btnRefresh'].forEach(id=>document.getElementById(id).disabled=false);
    refreshRooms(); startPing(); startRoomListAutoRefresh();
  };
  ws.onclose=()=>{
    updateBanner('err','Ïó∞Í≤∞ ÎÅäÍπÄ');
    setConnStatus('err');
    ['btnCreate','btnRefresh'].forEach(id=>document.getElementById(id).disabled=true);
    stopPing(); stopRoomListAutoRefresh();
    if(currentRoomId) forceDisconnectToLobby();
    setTimeout(()=>tryConnect(url),4000);
  };
  ws.onmessage=e=>{let m;try{m=JSON.parse(e.data);}catch{return;}handleMsg(m);};
}
function updateBanner(state,text){
  const b=document.getElementById('serverBanner'),d=document.getElementById('bannerDot'),t=document.getElementById('bannerText');
  b.style.display = state==='ok' ? 'none' : 'flex';
  b.className='server-banner '+state;
  d.className='dot '+(state==='ok'?'ok':state==='err'?'err':'');
  t.textContent=text||(state==='connecting'?'ÏÑúÎ≤Ñ ÏûêÎèô Ïó∞Í≤∞ Ï§ë...':'');
}

function initAudio(){
  if(audioCtx) return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain(); masterGain.gain.value=volume; masterGain.connect(audioCtx.destination);
}
async function ensureAudioReady(){
  if(!audioCtx) initAudio();
  if(audioCtx && audioCtx.state==='suspended'){
    try{await audioCtx.resume();}catch{}
  }
  updateAudioGreeting();
  flushPendingNoteOns();
}
function updateAudioGreeting(){
  const el=document.getElementById('audioGreeting');
  if(!el) return;
  const unlocked=!!(audioCtx && audioCtx.state==='running');
  el.style.display=(audioGreetingDismissed||unlocked)?'none':'inline-flex';
}
async function unlockAudioFromGreeting(){
  audioGreetingDismissed=true;
  await ensureAudioReady();
  autoEnableMidi();
  updateAudioGreeting();
}
function setVolume(v){volume=parseFloat(v);if(masterGain)masterGain.gain.value=volume;}
function midiToFreq(n){return 440*Math.pow(2,(n-69)/12);}
function markOutboundMidi(s,n,v){
  recentOutboundMidi.set((s&0xf0)+'_'+n+'_'+v,Date.now());
}
function isRecentOutboundMidi(s,n,v){
  const key=(s&0xf0)+'_'+n+'_'+v;
  const t=recentOutboundMidi.get(key);
  if(!t) return false;
  if(Date.now()-t>80){recentOutboundMidi.delete(key);return false;}
  return true;
}
function refreshMidiOutputs(){
  if(!midiAccess){midiOutputs=[];return;}
  midiOutputs=[...midiAccess.outputs.values()];
}
function sendMidiToDaw(status,data1,data2=0){
  if(!midiOutputs.length) return;
  const s=status&0xff,d1=data1&0x7f,d2=data2&0x7f;
  markOutboundMidi(s,d1,d2);
  for(const out of midiOutputs){
    try{out.send([s,d1,d2]);}catch{}
  }
}
function playNote(note,vel=100,remote=false){
  if(!audioCtx) initAudio();
  if(audioCtx.state==='suspended') return null;
  const now=audioCtx.currentTime;
  const f=midiToFreq(note);
  const o1=audioCtx.createOscillator(),o2=audioCtx.createOscillator();
  const g1=audioCtx.createGain(),g2=audioCtx.createGain();
  // Short pluck envelope: quick attack + fast decay (pedal-independent feel)
  o1.type='sawtooth';o1.frequency.value=f;
  o2.type='triangle';o2.frequency.value=f*2.01;
  const peak=(vel/127)*(remote?.22:.32);
  g1.gain.setValueAtTime(0.0001,now);
  g2.gain.setValueAtTime(0.0001,now);
  g1.gain.exponentialRampToValueAtTime(Math.max(0.001,peak),now+0.004);
  g2.gain.exponentialRampToValueAtTime(Math.max(0.0006,peak*0.18),now+0.006);
  g1.gain.exponentialRampToValueAtTime(0.0001,now+(remote?0.26:0.34));
  g2.gain.exponentialRampToValueAtTime(0.0001,now+(remote?0.2:0.28));
  o1.connect(g1);o2.connect(g2);g1.connect(masterGain);g2.connect(masterGain);
  o1.start();o2.start();
  return{o1,o2,g1,g2};
}
function killNote(key,map){
  const n=map.get(key);if(!n)return;
  n.g1.gain.setTargetAtTime(0,audioCtx.currentTime,.03);
  n.g2.gain.setTargetAtTime(0,audioCtx.currentTime,.03);
  setTimeout(()=>{try{n.o1.stop();n.o2.stop();}catch{}},120);
  map.delete(key);
}
function flushPendingNoteOns(){
  if(!audioCtx || audioCtx.state==='suspended' || pendingNoteOns.size===0) return;
  const pending=Array.from(pendingNoteOns.entries());
  pendingNoteOns.clear();
  for(const [note,vel] of pending){
    if(!heldLocalNotes.has(note)) continue;
    localNoteOn(note,vel);
  }
}

const whiteX={};
function buildKeyboard88(){
  const kb=document.getElementById('keyboard');kb.innerHTML='';let wi=0;
  for(let n=MIDI_MIN;n<=MIDI_MAX;n++){if(!IS_BLACK[n%12]){whiteX[n]=wi*WKW;wi++;}}
  kb.style.width=(wi*WKW)+'px';kb.style.height=WKH+'px';
  for(let n=MIDI_MIN;n<=MIDI_MAX;n++){
    const deg=n%12;if(IS_BLACK[deg])continue;
    const oct=Math.floor(n/12)-1;
    const el=document.createElement('div');el.className='wkey';el.dataset.note=n;
    el.style.left=whiteX[n]+'px';el.style.width=WKW+'px';el.style.height=WKH+'px';
    if(deg===0){const lb=document.createElement('div');lb.className='key-label';lb.textContent='C'+oct;el.appendChild(lb);}
    addKeyEvents(el,n);kb.appendChild(el);
  }
  for(let n=MIDI_MIN;n<=MIDI_MAX;n++){
    const deg=n%12;if(!IS_BLACK[deg])continue;
    const lx=whiteX[n-1];if(lx===undefined)continue;
    const el=document.createElement('div');el.className='bkey';el.dataset.note=n;
    el.style.left=(lx+WKW-BKW/2)+'px';el.style.width=BKW+'px';el.style.height=BKH+'px';
    addKeyEvents(el,n);kb.appendChild(el);
  }
  setTimeout(()=>scrollToNote(60),120);
}
function buildLobbyKeyboard88(){
  const src=document.getElementById('keyboard');
  const dst=document.getElementById('lobbyKeyboard');
  if(!src||!dst) return;
  dst.innerHTML=src.innerHTML;
  dst.style.width=src.style.width;
  dst.style.height=src.style.height;
  dst.style.transformOrigin='top center';
  dst.style.margin='0 auto';
  dst.querySelectorAll('.wkey,.bkey').forEach(el=>{
    const note=parseInt(el.dataset.note,10);
    if(!Number.isNaN(note)) addKeyEvents(el,note);
  });
  const sc=document.getElementById('lobbyPianoScroll');
  if(sc){
    const fullW=parseInt(src.style.width,10)||1768;
    const avail=Math.max(320,sc.clientWidth-24);
    const scale=Math.min(1,avail/fullW);
    dst.style.transform='scale('+scale+')';
    sc.style.height=(Math.round(WKH*scale)+18)+'px';
  }
}
function getKeyEl(n,rootId='keyboard'){
  const root=document.getElementById(rootId);
  if(!root) return null;
  return root.querySelector('[data-note="'+n+'"]');
}
function setKeyVisual(note,on,isLocal,color){
  ['keyboard','lobbyKeyboard'].forEach(rootId=>{
    const el=getKeyEl(note,rootId);if(!el)return;
    if(isLocal){
      if(on){
        el.classList.add('pressed-local');
        el.style.setProperty('background','linear-gradient(180deg,'+myColor+' 0%,'+brighten(myColor)+' 100%)','important');
        el.style.setProperty('box-shadow','inset 0 3px 10px rgba(0,0,0,.35),0 0 20px '+myColor+'99','important');
      }else{
        el.classList.remove('pressed-local');
        const r=pressedRemoteVisual.get(note);
        if(r&&r.length){
          const rc=r[r.length-1].color;
          el.classList.add('pressed-remote');
          el.style.setProperty('background','linear-gradient(180deg,'+rc+' 0%,'+brighten(rc)+' 100%)','important');
          el.style.setProperty('box-shadow','inset 0 3px 10px rgba(0,0,0,.35),0 0 18px '+rc+'99','important');
        }else if(!el.classList.contains('pressed-remote')){
          el.style.removeProperty('background');el.style.removeProperty('box-shadow');
        }
      }
    } else {
      if(on&&color){
        el.classList.add('pressed-remote');
        el.style.setProperty('background','linear-gradient(180deg,'+color+' 0%,'+brighten(color)+' 100%)','important');
        el.style.setProperty('box-shadow','inset 0 3px 10px rgba(0,0,0,.35),0 0 18px '+color+'99','important');
      } else {
        el.classList.remove('pressed-remote');
        if(pressedLocal.has(note)){
          el.style.setProperty('background','linear-gradient(180deg,'+myColor+' 0%,'+brighten(myColor)+' 100%)','important');
          el.style.setProperty('box-shadow','inset 0 3px 10px rgba(0,0,0,.35),0 0 20px '+myColor+'99','important');
        }else{
          el.style.removeProperty('background');el.style.removeProperty('box-shadow');
        }
      }
    }
  });
}
function brighten(hex){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  const mix=0.25;
  const nr=Math.floor(r+(255-r)*mix),ng=Math.floor(g+(255-g)*mix),nb=Math.floor(b+(255-b)*mix);
  return'rgb('+nr+','+ng+','+nb+')';
}
function addKeyEvents(el,note){
  el.addEventListener('mousedown',e=>{
    e.preventDefault();
    mouseDragActive=true;
    dragCurrentNote=null;
    ensureAudioReady().then(()=>{
      if(!mouseDragActive) return;
      dragToNote(note);
    });
  });
  el.addEventListener('mouseenter',()=>{if(mouseDragActive)dragToNote(note);});
  el.addEventListener('mouseup',endMouseDrag);
  el.addEventListener('touchstart',e=>{
    e.preventDefault();
    heldLocalNotes.add(note);
    ensureAudioReady().then(()=>{
      if(!heldLocalNotes.has(note)) return;
      localNoteOn(note,100);
    });
  },{passive:false});
  el.addEventListener('touchend',()=>localNoteOff(note));
}
function dragToNote(note){
  if(dragCurrentNote===note)return;
  if(dragCurrentNote!==null)localNoteOff(dragCurrentNote,true);
  localNoteOn(note,100);
  dragCurrentNote=note;
}
function endMouseDrag(){
  if(!mouseDragActive)return;
  mouseDragActive=false;
  if(dragCurrentNote!==null)localNoteOff(dragCurrentNote,true);
  dragCurrentNote=null;
}
document.addEventListener('mouseup',endMouseDrag);
window.addEventListener('blur',endMouseDrag);
function scrollOctave(dir){
  document.getElementById('pianoScroll').scrollBy({left:dir*7*WKW,behavior:'smooth'});
  setTimeout(updateViewLabel,300);
}
function scrollToNote(n){
  const sc=document.getElementById('pianoScroll'),el=getKeyEl(n,'keyboard');if(!el)return;
  sc.scrollLeft=parseInt(el.style.left)-sc.clientWidth/2+WKW/2;
  setTimeout(updateViewLabel,200);
}
function updateViewLabel(){
  const sc=document.getElementById('pianoScroll'),cx=sc.scrollLeft+sc.clientWidth/2;
  let best=MIDI_MIN,bestDist=1e9;
  for(const [n,x] of Object.entries(whiteX)){
    const d=Math.abs(x-cx);if(d<bestDist){bestDist=d;best=parseInt(n);}
  }
  const label=document.getElementById('viewLabel');
  if(label)label.textContent=NOTE_NAMES[best%12]+(Math.floor(best/12)-1);
}
document.getElementById('pianoScroll').addEventListener('scroll',updateViewLabel);

function localNoteOn(note,vel){
  heldLocalNotes.add(note);
  if(!audioCtx||audioCtx.state==='suspended'){
    pendingNoteOns.set(note,vel);
    ensureAudioReady();
    return;
  }
  pendingNoteOns.delete(note);
  if(pressedLocal.has(note)){
    // Allow re-trigger even while pedal is down.
    killNote(note,activeOsc);
    pressedLocal.delete(note);
  }
  pressedLocal.add(note);setKeyVisual(note,true,true,myColor);
  const n=playNote(note,vel,false);if(n)activeOsc.set(note,n);
  sustainedNotes.delete(note);
  updateActiveNotes();
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'midi',data:{type:'noteOn',note,velocity:vel}}));
}
function stopLocalNoteNow(note){
  if(!pressedLocal.has(note))return;
  pressedLocal.delete(note);setKeyVisual(note,false,true,null);
  killNote(note,activeOsc);updateActiveNotes();
  sustainedNotes.delete(note);
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'midi',data:{type:'noteOff',note}}));
}
function localNoteOff(note,fromPhysical=true){
  if(fromPhysical) heldLocalNotes.delete(note);
  pendingNoteOns.delete(note);
  if(sustainPedalDown && fromPhysical){
    if(pressedLocal.has(note)) sustainedNotes.add(note);
    setKeyVisual(note,false,true,null);
    if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'midi',data:{type:'noteVisualOff',note}}));
    return;
  }
  stopLocalNoteNow(note);
}
function setSustainPedal(isDown){
  sustainPedalDown=isDown;
  if(sustainPedalDown) return;
  for(const note of Array.from(sustainedNotes)){
    if(!heldLocalNotes.has(note)) stopLocalNoteNow(note);
  }
}
function remoteNoteOn(note,sid,sname,scolor,vel){
  if(!pressedRemote.has(note))pressedRemote.set(note,[]);
  if(!pressedRemoteVisual.has(note))pressedRemoteVisual.set(note,[]);
  const list=pressedRemote.get(note);
  const vlist=pressedRemoteVisual.get(note);
  if(!list.find(x=>x.sid===sid))list.push({sid,color:scolor,name:sname});
  if(!vlist.find(x=>x.sid===sid))vlist.push({sid,color:scolor,name:sname});
  setKeyVisual(note,true,false,vlist[vlist.length-1].color);
  sendMidiToDaw(0x90,note,vel||100);
  const key=sid+'_'+note;
  if(!remoteOsc.has(key)){const n=playNote(note,vel,true);if(n)remoteOsc.set(key,n);}
  updateActiveNotes();
}
function remoteNoteOff(note,sid){
  sendMidiToDaw(0x80,note,0);
  killNote(sid+'_'+note,remoteOsc);
  if(pressedRemote.has(note)){
    const list=pressedRemote.get(note).filter(x=>x.sid!==sid);
    if(list.length===0) pressedRemote.delete(note);
    else pressedRemote.set(note,list);
  }
  if(pressedRemoteVisual.has(note)){
    const vlist=pressedRemoteVisual.get(note).filter(x=>x.sid!==sid);
    if(vlist.length===0){pressedRemoteVisual.delete(note);setKeyVisual(note,false,false,null);}
    else{pressedRemoteVisual.set(note,vlist);setKeyVisual(note,true,false,vlist[vlist.length-1].color);}
  }
  updateActiveNotes();
}
function remoteNoteVisualOff(note,sid){
  if(!pressedRemoteVisual.has(note)) return;
  const vlist=pressedRemoteVisual.get(note).filter(x=>x.sid!==sid);
  if(vlist.length===0){
    pressedRemoteVisual.delete(note);
    if(!pressedLocal.has(note)) setKeyVisual(note,false,false,null);
  }else{
    pressedRemoteVisual.set(note,vlist);
    setKeyVisual(note,true,false,vlist[vlist.length-1].color);
  }
}
function updateActiveNotes(){
  const el=document.getElementById('activeNotes');
  if(el){
    el.innerHTML='';
    el.style.display='none';
  }
}

function handleMsg(msg){
  switch(msg.type){
    case 'room_joined':
      myId=msg.clientId;currentRoomId=msg.roomId;
      document.getElementById('sessRoomId').textContent=msg.roomId;
      document.getElementById('sessRoomName').textContent=msg.roomInfo.name;
      updatePlayers(msg.roomInfo.players);showScreen('session');scrollToNote(60);
      break;
    case 'player_joined':
      updatePlayers(msg.roomInfo.players);
      addChat(null,msg.player.name+'ÎãòÏù¥ ÏûÖÏû•ÌñàÏäµÎãàÎã§',msg.player.color);break;
    case 'player_left':
      updatePlayers(msg.roomInfo.players);
      addChat(null,msg.playerName+'ÎãòÏù¥ Ìá¥Ïû•ÌñàÏäµÎãàÎã§','#556');
      for(const[key]of remoteOsc){if(key.startsWith(msg.playerId+'_')){remoteNoteOff(parseInt(key.split('_')[1]),msg.playerId);}}
      break;
    case 'midi':
      if(msg.senderId===myId) break;
      if(msg.data.type==='noteOn'){
        const c=msg.senderColor||(playerMap.has(msg.senderId)?playerMap.get(msg.senderId).color:'#ff6b35');
        remoteNoteOn(msg.data.note,msg.senderId,msg.senderName,c,msg.data.velocity);
      }
      else if(msg.data.type==='noteOff')remoteNoteOff(msg.data.note,msg.senderId);
      else if(msg.data.type==='noteVisualOff')remoteNoteVisualOff(msg.data.note,msg.senderId);
      else if(msg.data.type==='controlChange' && msg.data.controller===64){
        sendMidiToDaw(0xB0,64,msg.data.value||0);
      }
      break;
    case 'color_changed':
      if(playerMap.has(msg.playerId)){playerMap.get(msg.playerId).color=msg.color;renderPlayers();renderLatency();}
      break;
    case 'pong':
      const rtt=Date.now()-msg.clientTime;
      if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'latency_report',pingMs:rtt}));
      updateMyLatency(rtt);break;
    case 'latency_update':latencyMap.set(msg.playerId,msg.pingMs);renderPlayers();renderLatency();break;
    case 'room_list':renderRoomList(msg.rooms);break;
    case 'chat':addChat(msg.senderName,msg.message,msg.senderColor);break;
    case 'left_room':
      break;
    case 'error':toast(msg.message,true);break;
  }
}

function createRoom(){
  if(!ws||ws.readyState!==1){toast('ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌïÑÏöî',true);return;}
  const pw=document.getElementById('createPw').value.trim();
  if(pw && !/^\d{4}$/.test(pw)){toast('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî Ïà´Ïûê 4ÏûêÎ¶¨Îßå Í∞ÄÎä•',true);return;}
  myColor=createColorSel;myName=document.getElementById('createPlayerName').value||'Musician';
  ws.send(JSON.stringify({type:'create_room',name:document.getElementById('createName').value||'Room',
    password:pw,maxPlayers:parseInt(document.getElementById('createMax').value),
    playerName:myName,color:myColor}));
}
function joinRoom(room){
  pendingJoinRoom=room;
  if(room.hasPassword){document.getElementById('pwModal').classList.add('open');setTimeout(()=>document.getElementById('modalPw').focus(),80);}
  else attemptJoin(room.id,'');
}
function confirmPw(){
  const p=document.getElementById('modalPw').value.trim();
  if(!/^\d{4}$/.test(p)){toast('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî Ïà´Ïûê 4ÏûêÎ¶¨Îßå Í∞ÄÎä•',true);return;}
  closePwModal();attemptJoin(pendingJoinRoom.id,p);
}
function closePwModal(){document.getElementById('pwModal').classList.remove('open');document.getElementById('modalPw').value='';}
function attemptJoin(rid,pw){
  if(!ws||ws.readyState!==1){toast('ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌïÑÏöî',true);return;}
  myColor=joinColorSel;myName=document.getElementById('joinPlayerName').value||'Musician';
  ws.send(JSON.stringify({type:'join_room',roomId:rid,password:pw,playerName:myName,color:myColor}));
}

function leaveRoom(){
  if(ws&&ws.readyState===1&&currentRoomId){
    ws.send(JSON.stringify({type:'leave_room'}));
  }
  pressedLocal.forEach(n=>localNoteOff(n));
  activeOsc.forEach((val, key) => killNote(key, activeOsc));
  remoteOsc.forEach((val, key) => killNote(key, remoteOsc));
  pressedRemote.clear();pressedRemoteVisual.clear();
  sustainPedalDown=false;heldLocalNotes.clear();sustainedNotes.clear();
  pendingNoteOns.clear();
  currentRoomId=null;myId=null;latencyMap.clear();playerMap.clear();
  document.getElementById('chatMsgs').innerHTML='';
  document.getElementById('activeNotes').innerHTML='';
  showScreen('lobby');
  refreshRooms();
}
function resetAllNotes(){
  for(const note of Array.from(pressedLocal)) localNoteOff(note,true);
  for(const [key] of Array.from(activeOsc)) killNote(key,activeOsc);
  for(const [key] of Array.from(remoteOsc)) killNote(key,remoteOsc);
  pressedLocal.clear();
  pressedRemote.clear();
  pressedRemoteVisual.clear();
  heldLocalNotes.clear();
  sustainedNotes.clear();
  pendingNoteOns.clear();
  sustainPedalDown=false;
  for(let n=MIDI_MIN;n<=MIDI_MAX;n++){
    setKeyVisual(n,false,true,null);
    setKeyVisual(n,false,false,null);
  }
  updateActiveNotes();
  toast('reset: Î™®Îì† ÏÜåÎ¶¨ Ï†ïÏßÄ');
}

function forceDisconnectToLobby(){
  pressedLocal.forEach(n=>localNoteOff(n));
  activeOsc.forEach((val, key) => killNote(key, activeOsc));
  remoteOsc.forEach((val, key) => killNote(key, remoteOsc));
  pressedRemote.clear();pressedRemoteVisual.clear();
  sustainPedalDown=false;heldLocalNotes.clear();sustainedNotes.clear();
  pendingNoteOns.clear();
  currentRoomId=null;myId=null;latencyMap.clear();playerMap.clear();
  showScreen('lobby');
}

function refreshRooms(){if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'get_rooms'}));}
function startRoomListAutoRefresh(){
  stopRoomListAutoRefresh();
  roomListAutoTimer=setInterval(()=>{
    const lobby=document.getElementById('lobby');
    if(lobby && lobby.classList.contains('active')) refreshRooms();
  },1200);
}
function stopRoomListAutoRefresh(){
  if(roomListAutoTimer){clearInterval(roomListAutoTimer);roomListAutoTimer=null;}
}
function renderRoomList(rooms){
  const el=document.getElementById('roomList');el.innerHTML='';
  if(!rooms.length){el.innerHTML='<div class="no-rooms">ÌòÑÏû¨ ÏÉùÏÑ±Îêú Î∞© ÏóÜÏùå</div>';return;}
  rooms.forEach(r=>{
    const d=document.createElement('div');d.className='room-item';
    d.innerHTML='<div><div class="room-item-name"><button class="room-link" type="button">'+escHtml(r.name)+'</button></div><div class="room-item-meta">'+r.id+' ¬∑ '+r.players+'/'+r.maxPlayers+'Î™Ö</div></div><div class="room-badges">'+(r.hasPassword?'<span class="badge badge-lock">üîí ÎπÑÍ≥µÍ∞ú</span>':'<span class="badge">Í≥µÍ∞ú</span>')+'</div>';
    const link=d.querySelector('.room-link');
    if(r.players<r.maxPlayers){
      link.onclick=()=>joinRoom(r);
      d.onclick=()=>joinRoom(r);
    }else{
      link.disabled=true;
    }
    el.appendChild(d);
  });
}
function copyRoomId(){navigator.clipboard.writeText(document.getElementById('sessRoomId').textContent).then(()=>toast('ÏΩîÎìú Î≥µÏÇ¨ ÏôÑÎ£å'));}

function updatePlayers(players){playerMap.clear();players.forEach(p=>playerMap.set(p.id,p));renderPlayers();renderLatency();}
function renderPlayers(){
  const bar=document.getElementById('playersBar');bar.innerHTML='';
  for(const[id,p]of playerMap){
    const chip=document.createElement('div');chip.className='player-chip'+(id===myId?' mine':'');
    chip.innerHTML='<div class="player-dot" style="background:'+p.color+'"></div><span>'+escHtml(p.name)+'</span><span class="player-ping">'+(latencyMap.get(id)||0)+'ms</span>';
    if(id===myId)chip.onclick=e=>openColorPopover(e,chip);
    bar.appendChild(chip);
  }
}
function renderLatency(){
  const el=document.getElementById('latencyPanel');el.innerHTML='';
  for(const[id,p]of playerMap){
    const ms=latencyMap.get(id)||0,pct=Math.min(100,ms/3),col=ms<60?'var(--green)':ms<150?'#ffcc00':'var(--danger)';
    const item=document.createElement('div');item.className='lat-item';
    item.innerHTML='<div style="width:6px;height:6px;border-radius:50%;background:'+p.color+'"></div><div class="lat-bar"><div class="lat-fill" style="width:'+pct+'%;background:'+col+'"></div></div><span>'+ms+'ms</span>';
    el.appendChild(item);
  }
}
function updateMyLatency(ms){if(myId){latencyMap.set(myId,ms);renderPlayers();renderLatency();}}

function buildPopoverSwatches(){
  const el=document.getElementById('popoverSwatches');
  COLORS.forEach(c=>{
    const d=document.createElement('div');d.className='cswatch';d.style.background=c;
    d.onclick=()=>{changeMyColor(c);closeColorPopover();};
    el.appendChild(d);
  });
}
function openColorPopover(e,anchor){
  e.stopPropagation();const pop=document.getElementById('colorPopover'),rect=anchor.getBoundingClientRect();
  pop.style.top=(rect.bottom+8)+'px';pop.style.left=Math.min(rect.left,window.innerWidth-210)+'px';
  pop.classList.add('open');
}
function closeColorPopover(){document.getElementById('colorPopover').classList.remove('open');}
document.addEventListener('click',e=>{if(!e.target.closest('#colorPopover'))closeColorPopover();});
function changeMyColor(c){
  myColor=c;if(myId&&playerMap.has(myId))playerMap.get(myId).color=c;
  // Immediately repaint currently pressed local keys with the new player color.
  for(const n of pressedLocal) setKeyVisual(n,true,true,myColor);
  renderPlayers();renderLatency();
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'color_change',color:c}));
}

function startPing(){stopPing();pingInterval=setInterval(()=>{if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'ping',clientTime:Date.now()}));},2000);}
function stopPing(){if(pingInterval)clearInterval(pingInterval);}

async function toggleMidiInput(){
  if(midiConnected){disconnectMidi();return;}
  try{midiAccess=await navigator.requestMIDIAccess();connectMidi();}catch{toast('MIDI Í∂åÌïú ÌïÑÏöî',true);}
}
async function autoEnableMidi(){
  if(midiConnected || midiAutoAttempted || !('requestMIDIAccess' in navigator)) return;
  midiAutoAttempted=true;
  try{
    midiAccess=await navigator.requestMIDIAccess();
    connectMidi();
  }catch{
    midiAutoAttempted=false;
  }
}
function connectMidi(){
  if(!midiAccess) return;
  for(const i of midiAccess.inputs.values())i.onmidimessage=onMidiMessage;
  refreshMidiOutputs();
  midiAccess.onstatechange=()=>{
    for(const i of midiAccess.inputs.values())i.onmidimessage=onMidiMessage;
    refreshMidiOutputs();
  };
  midiConnected=true;
  document.getElementById('midiBadge').classList.add('active');toast('MIDI Ïó∞Í≤∞Îê®');
}
function disconnectMidi(){
  if(midiAccess)for(const i of midiAccess.inputs.values())i.onmidimessage=null;
  midiOutputs=[];
  midiConnected=false;
  document.getElementById('midiBadge').classList.remove('active');
}
function onMidiMessage(e){
  const[s,n,v]=e.data,cmd=s&0xf0;
  if(isRecentOutboundMidi(s,n,v)) return;
  if(cmd===0x90&&v>0)localNoteOn(n,v);
  else if(cmd===0x80||(cmd===0x90&&v===0))localNoteOff(n,true);
  else if(cmd===0xB0&&n===64){
    setSustainPedal(v>=64);
    if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'midi',data:{type:'controlChange',controller:64,value:v}}));
  }
}

function buildColorPickers(){
  [['createColors',0],['joinColors',1]].forEach(([id,i])=>{
    const el=document.getElementById(id);
    COLORS.forEach(c=>{
      const d=document.createElement('div');d.className='cswatch';d.style.background=c;
      d.onclick=()=>{
        el.querySelectorAll('.cswatch').forEach(s=>s.classList.remove('sel'));
        d.classList.add('sel');
        if(i===0)createColorSel=c;else joinColorSel=c;
        // In lobby, preview/play color should follow latest selected color immediately.
        myColor=c;
        for(const n of pressedLocal) setKeyVisual(n,true,true,myColor);
      };
      el.appendChild(d);
    });
  });
}
function sendChat(){
  const i=document.getElementById('chatInput'),m=i.value.trim();if(!m)return;
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'chat',message:m}));i.value='';
}
function addChat(n,m,c){
  const el=document.getElementById('chatMsgs'),d=document.createElement('div');d.className='chat-msg';
  d.innerHTML=n?'<span class="cn" style="color:'+c+'">'+escHtml(n)+'</span> '+escHtml(m):'<span style="font-style:italic">'+escHtml(m)+'</span>';
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}

const KB_NOTES={'a':60,'w':61,'s':62,'e':63,'d':64,'f':65,'t':66,'g':67,'y':68,'h':69,'u':70,'j':71,'k':72};
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT' || e.repeat) return;
  const n=KB_NOTES[e.key.toLowerCase()];if(n)localNoteOn(n,100);
  if(e.key==='ArrowLeft')scrollOctave(-1);if(e.key==='ArrowRight')scrollOctave(1);
});
document.addEventListener('keyup',e=>{const n=KB_NOTES[e.key.toLowerCase()];if(n)localNoteOff(n);});

function showScreen(n){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(n).classList.add('active');
  if(n==='lobby') refreshRooms();
  window.scrollTo(0,0);
}
function setConnStatus(s){
  document.getElementById('connDot').className='dot '+(s==='ok'?'ok':s==='err'?'err':'');
  document.getElementById('connLabel').textContent=s==='ok'?'Ïó∞Í≤∞Îê®':s==='err'?'Ïó∞Í≤∞ ÎÅäÍπÄ':'Ïó∞Í≤∞ Ï§ë...';
}
function toast(m,e=false){
  const t=document.getElementById('toast');t.textContent=m;t.className='toast show'+(e?' error':'');
  setTimeout(()=>t.classList.remove('show'),3000);
}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
</script>
</body>
</html>
