<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SyncKeys ‚Äî Ïã§ÏãúÍ∞Ñ ÏõêÍ≤© Ìï©Ï£º</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#08080e;--surface:#101018;--surface2:#181824;--border:#252535;--border2:#303050;--accent:#00e5ff;--accent2:#ff6b35;--green:#00ff88;--text:#dde0f0;--danger:#ff4466;}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans KR',sans-serif;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,229,255,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.025) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0;}
.wrap{position:relative;z-index:1;}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:rgba(8,8,14,.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
.logo{font-family:'Space Mono',monospace;font-size:18px;font-weight:700;letter-spacing:3px;}
.logo .k{color:var(--accent);}.logo .s{color:var(--accent2);}
.header-right{display:flex;gap:12px;align-items:center;}
.conn-status{display:flex;align-items:center;gap:8px;font-family:'Space Mono',monospace;font-size:11px;color:#556;}
.dot{width:8px;height:8px;border-radius:50%;background:#333;transition:all .4s;}
.dot.ok{background:var(--green);box-shadow:0 0 8px var(--green);}
.dot.err{background:var(--danger);}
.midi-badge{padding:3px 10px;border-radius:20px;font-family:'Space Mono',monospace;font-size:10px;border:1px solid var(--border);color:#556;transition:all .2s;}
.midi-badge.active{border-color:var(--green);color:var(--green);box-shadow:0 0 8px rgba(0,255,136,.3);}
.screen{display:none;}
.screen.active{display:block;}
#session{display:none;flex-direction:column;}
#session.active{display:flex;height:100vh;}
#lobby{max-width:860px;margin:0 auto;padding:48px 20px;}
.hero{text-align:center;margin-bottom:40px;}
.hero h1{font-family:'Space Mono',monospace;font-size:clamp(28px,6vw,56px);color:var(--accent);text-shadow:0 0 60px rgba(0,229,255,.35);line-height:1.1;margin-bottom:14px;}
.hero p{color:#556088;font-size:14px;font-weight:300;}
.server-banner{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px 20px;margin-bottom:28px;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-family:'Space Mono',monospace;font-size:12px;color:#556;transition:all .3s;}
.server-banner.ok{border-color:var(--green);color:var(--green);}
.server-banner.err{border-color:var(--danger);color:var(--danger);}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
@media(max-width:600px){.grid2{grid-template-columns:1fr;}}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:26px;transition:border-color .25s;}
.card:hover{border-color:var(--border2);}
.card-title{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:20px;}
.field{margin-bottom:14px;}
.field label{display:block;font-size:10px;color:#556;letter-spacing:1px;text-transform:uppercase;font-family:'Space Mono',monospace;margin-bottom:5px;}
.field input,.field select{width:100%;padding:9px 13px;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'Space Mono',monospace;font-size:12px;outline:none;transition:border-color .2s;}
.field input:focus,.field select:focus{border-color:var(--accent);}
.colors{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;}
.cswatch{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .2s,border-color .2s;}
.cswatch:hover,.cswatch.sel{transform:scale(1.25);border-color:#fff;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:10px 22px;border:none;border-radius:8px;cursor:pointer;font-family:'Space Mono',monospace;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;transition:all .2s;}
.btn-primary{background:var(--accent);color:#000;box-shadow:0 0 18px rgba(0,229,255,.25);}
.btn-primary:hover{box-shadow:0 0 30px rgba(0,229,255,.5);transform:translateY(-1px);}
.btn-outline{background:transparent;color:var(--accent);border:1px solid var(--accent);}
.btn-outline:hover{background:rgba(0,229,255,.08);}
.btn-red{background:transparent;color:var(--danger);border:1px solid var(--danger);}
.btn-red:hover{background:rgba(255,68,102,.08);}
.btn-full{width:100%;margin-top:6px;}
.btn:disabled{opacity:.38;cursor:not-allowed;transform:none!important;box-shadow:none!important;}
.room-list{margin-top:24px;}
.room-list-title{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:#446;margin-bottom:12px;}
.room-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;margin-bottom:8px;background:var(--surface);border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:all .2s;}
.room-item:hover{border-color:var(--accent);background:rgba(0,229,255,.04);}
.room-item-name{font-weight:700;font-size:14px;margin-bottom:3px;}
.room-item-meta{font-family:'Space Mono',monospace;font-size:11px;color:#556;}
.room-badges{display:flex;gap:6px;}
.badge{padding:2px 9px;border-radius:20px;font-size:10px;font-family:'Space Mono',monospace;border:1px solid var(--border);}
.badge-lock{border-color:var(--accent2);color:var(--accent2);}
.badge-full{border-color:var(--danger);color:var(--danger);}
.no-rooms{text-align:center;padding:28px;color:#446;font-size:13px;}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:300;}
.modal-bg.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--accent);border-radius:16px;padding:30px;width:340px;box-shadow:0 0 60px rgba(0,229,255,.18);animation:popIn .25s ease;}
@keyframes popIn{from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}
.modal h3{font-family:'Space Mono',monospace;color:var(--accent);margin-bottom:18px;}
.modal-btns{display:flex;gap:10px;margin-top:16px;}
.sess-top{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px;flex-shrink:0;}
.sess-room-name{font-family:'Space Mono',monospace;font-size:15px;color:var(--accent);font-weight:700;}
.room-id-tag{font-family:'Space Mono',monospace;font-size:11px;padding:3px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;color:#556;cursor:pointer;user-select:all;transition:border-color .2s;}
.room-id-tag:hover{border-color:var(--accent);color:var(--accent);}
.sess-controls{display:flex;align-items:center;gap:10px;}
.vol-row{display:flex;align-items:center;gap:8px;font-family:'Space Mono',monospace;font-size:10px;color:#556;}
.vol-row input[type=range]{width:80px;accent-color:var(--accent);}
.players-bar{display:flex;gap:8px;padding:8px 20px;background:rgba(8,8,14,.6);border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center;flex-shrink:0;}
.player-chip{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);font-size:12px;transition:border-color .2s;}
.player-chip.mine{cursor:pointer;border-style:dashed;}
.player-chip.mine:hover{border-color:var(--accent);}
.player-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.player-ping{font-family:'Space Mono',monospace;font-size:10px;color:#556;}
.latency-panel{display:flex;gap:16px;padding:6px 20px;background:rgba(8,8,14,.5);border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center;flex-shrink:0;}
.lat-item{display:flex;align-items:center;gap:7px;font-family:'Space Mono',monospace;font-size:10px;}
.lat-bar{width:56px;height:5px;background:#151525;border-radius:3px;overflow:hidden;}
.lat-fill{height:100%;border-radius:3px;transition:width .6s,background .6s;}
.lat-ms{min-width:38px;}
.sess-main{display:flex;flex:1;flex-direction:column;overflow:hidden;min-height:0;}
.piano-area{flex:1;display:flex;flex-direction:column;min-height:0;background:#070710;}
.piano-toolbar{display:flex;align-items:center;justify-content:center;gap:14px;padding:7px 20px;flex-shrink:0;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace;font-size:11px;}
.scroll-hint{color:#334;font-size:10px;letter-spacing:1px;}
.oct-btn{width:28px;height:28px;border-radius:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:'Space Mono',monospace;}
.oct-btn:hover{border-color:var(--accent);color:var(--accent);}
.view-label{color:var(--accent);font-size:12px;min-width:50px;text-align:center;}
.piano-scroll{flex:1;overflow-x:auto;overflow-y:hidden;display:flex;align-items:flex-end;padding:16px 32px 0;scrollbar-width:thin;scrollbar-color:#252535 #070710;scroll-behavior:smooth;}
.piano-scroll::-webkit-scrollbar{height:6px;}
.piano-scroll::-webkit-scrollbar-track{background:#070710;}
.piano-scroll::-webkit-scrollbar-thumb{background:#252535;border-radius:3px;}
.piano-scroll::-webkit-scrollbar-thumb:hover{background:var(--accent);}
.keyboard{position:relative;flex-shrink:0;user-select:none;}
.wkey{height:200px;background:linear-gradient(180deg,#dde0f0 0%,#f0f0ff 60%,#e8e8f8 100%);border:1px solid #9090b0;border-top:3px solid #c0c0d8;border-radius:0 0 6px 6px;cursor:pointer;position:absolute;transition:background .05s;box-shadow:inset 0 -3px 5px rgba(0,0,0,.08),1px 0 3px rgba(0,0,0,.12);}
.wkey:hover{background:linear-gradient(180deg,#c8eeff 0%,#e0f8ff 100%);}
.wkey.pressed-local{background:linear-gradient(180deg,var(--accent) 0%,#009bcc 100%)!important;box-shadow:inset 0 3px 10px rgba(0,0,0,.35),0 0 20px rgba(0,229,255,.65)!important;transform:scaleY(.975);transform-origin:top;}
.wkey.pressed-remote{box-shadow:inset 0 3px 10px rgba(0,0,0,.35),0 0 18px rgba(255,255,255,.35)!important;transform:scaleY(.975);transform-origin:top;}
.key-label{position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-family:'Space Mono',monospace;font-size:7px;color:#9090b8;pointer-events:none;white-space:nowrap;}
.bkey{height:124px;background:linear-gradient(180deg,#1c1c2e 0%,#2a2a42 80%,#1a1a2e 100%);border:1px solid #404060;border-top:none;border-radius:0 0 4px 4px;position:absolute;top:0;z-index:2;cursor:pointer;box-shadow:2px 5px 10px rgba(0,0,0,.6),inset 0 1px 0 rgba(255,255,255,.05);transition:background .05s;}
.bkey:hover{background:linear-gradient(180deg,#2a2a44 0%,#383856 100%);}
.bkey.pressed-local{background:linear-gradient(180deg,var(--accent) 0%,#007799 100%)!important;box-shadow:inset 0 3px 8px rgba(0,0,0,.4),0 0 16px rgba(0,229,255,.8)!important;}
.bkey.pressed-remote{box-shadow:inset 0 3px 8px rgba(0,0,0,.4),0 0 14px rgba(255,255,255,.45)!important;}
.active-notes{padding:6px 20px;display:flex;gap:6px;flex-wrap:wrap;min-height:30px;max-height:50px;overflow:hidden;align-items:center;flex-shrink:0;border-top:1px solid var(--border);background:rgba(8,8,14,.7);}
.note-tag{padding:1px 9px;border-radius:20px;font-family:'Space Mono',monospace;font-size:10px;border:1px solid;animation:noteIn .06s ease;}
@keyframes noteIn{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
.chat-panel{height:118px;display:flex;flex-direction:column;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0;}
.chat-msgs{flex:1;overflow-y:auto;padding:6px 16px;scrollbar-width:thin;scrollbar-color:#222 transparent;}
.chat-msg{font-size:12px;line-height:1.5;margin-bottom:2px;}
.chat-msg .cn{font-weight:700;font-family:'Space Mono',monospace;font-size:11px;}
.chat-row{display:flex;gap:8px;padding:5px 12px;border-top:1px solid var(--border);flex-shrink:0;}
.chat-row input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 12px;color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:12px;outline:none;}
.chat-row input:focus{border-color:var(--accent);}
.color-popover{position:fixed;z-index:400;background:var(--surface);border:1px solid var(--accent);border-radius:12px;padding:14px 16px;box-shadow:0 8px 32px rgba(0,0,0,.6),0 0 24px rgba(0,229,255,.2);display:none;flex-direction:column;gap:10px;min-width:196px;animation:popIn .18s ease;}
.color-popover.open{display:flex;}
.color-popover-title{font-family:'Space Mono',monospace;font-size:10px;color:#556;letter-spacing:1px;text-transform:uppercase;}
.color-popover-swatches{display:flex;gap:8px;flex-wrap:wrap;}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface);border:1px solid var(--accent);border-radius:8px;padding:10px 20px;font-family:'Space Mono',monospace;font-size:12px;color:var(--accent);transition:transform .3s;z-index:500;white-space:nowrap;box-shadow:0 0 20px rgba(0,229,255,.15);pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.error{border-color:var(--danger);color:var(--danger);}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo"><span class="k">SYNC</span><span class="s">KEYS</span></div>
  <div class="header-right">
    <div class="midi-badge" id="midiBadge">NO MIDI</div>
    <div class="conn-status"><div class="dot" id="connDot"></div><span id="connLabel">Ïó∞Í≤∞ Ï§ë...</span></div>
  </div>
</header>

<div class="screen active" id="lobby">
  <div class="hero">
    <h1>Ïã§ÏãúÍ∞Ñ ÏõêÍ≤©<br>Ìï©Ï£º ÌîåÎû´Ìèº</h1>
    <p>ÏïºÎßàÌïò Ïã±ÌÅ¨Î£∏Ï≤òÎüº ‚Äî Ïñ¥ÎîîÏÑúÎì† Ìï®Íªò Ïó∞Ï£ºÌïòÏÑ∏Ïöî</p>
  </div>
  <div class="server-banner" id="serverBanner">
    <div class="dot" id="bannerDot"></div><span id="bannerText">ÏÑúÎ≤ÑÏóê ÏûêÎèô Ïó∞Í≤∞ Ï§ë...</span>
  </div>
  <div class="grid2">
    <div class="card">
      <div class="card-title">üéπ Î∞© ÎßåÎì§Í∏∞</div>
      <div class="field"><label>Î∞© Ïù¥Î¶Ñ</label><input type="text" id="createName" placeholder="My Jam Room" maxlength="40"></div>
      <div class="field"><label>ÎπÑÎ∞ÄÎ≤àÌò∏ (ÏÑ†ÌÉù)</label><input type="password" id="createPw" placeholder="ÏóÜÏúºÎ©¥ Í≥µÍ∞úÎ∞©"></div>
      <div class="field"><label>ÏµúÎåÄ Ïù∏Ïõê</label>
        <select id="createMax"><option value="2">2Î™Ö</option><option value="4" selected>4Î™Ö</option><option value="8">8Î™Ö</option><option value="16">16Î™Ö</option></select>
      </div>
      <div class="field"><label>ÎÇ¥ Ïù¥Î¶Ñ</label><input type="text" id="createPlayerName" placeholder="Musician" maxlength="20"></div>
      <div class="field"><label>ÎÇ¥ ÏÉâÏÉÅ</label><div class="colors" id="createColors"></div></div>
      <button class="btn btn-primary btn-full" onclick="createRoom()" id="btnCreate" disabled>Î∞© ÎßåÎì§Í∏∞</button>
    </div>
    <div class="card">
      <div class="card-title">üö™ Î∞© Ï∞∏Í∞Ä</div>
      <div class="field"><label>Î∞© ÏΩîÎìú ÏßÅÏ†ë ÏûÖÎ†•</label>
        <div style="display:flex;gap:8px">
          <input type="text" id="joinCode" placeholder="ABC123" maxlength="6" style="flex:1;text-transform:uppercase">
          <button class="btn btn-outline" onclick="joinByCode()" id="btnJoin" disabled>Ï∞∏Í∞Ä</button>
        </div>
      </div>
      <div class="field"><label>ÎÇ¥ Ïù¥Î¶Ñ</label><input type="text" id="joinPlayerName" placeholder="Musician" maxlength="20"></div>
      <div class="field"><label>ÎÇ¥ ÏÉâÏÉÅ</label><div class="colors" id="joinColors"></div></div>
      <div class="room-list">
        <div class="room-list-title">Í≥µÍ∞ú Î∞© Î™©Î°ù</div>
        <div id="roomList"><div class="no-rooms">ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</div></div>
      </div>
      <button class="btn btn-outline btn-full" onclick="refreshRooms()" id="btnRefresh" disabled style="margin-top:12px">ÏÉàÎ°úÍ≥†Ïπ®</button>
    </div>
  </div>
</div>

<div class="screen" id="session">
  <div class="sess-top">
    <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
      <div class="sess-room-name" id="sessRoomName">Room</div>
      <div class="room-id-tag" id="sessRoomId" onclick="copyRoomId()">------</div>
    </div>
    <div class="sess-controls">
      <div class="vol-row">üîä<input type="range" id="volSlider" min="0" max="1" step="0.05" value="0.7" oninput="setVolume(this.value)"></div>
      <button class="btn btn-outline" onclick="toggleMidiInput()" id="btnMidi">üéπ MIDI Ïó∞Í≤∞</button>
      <button class="btn btn-red" onclick="leaveRoom()">ÎÇòÍ∞ÄÍ∏∞</button>
    </div>
  </div>
  <div class="players-bar" id="playersBar"></div>
  <div class="latency-panel" id="latencyPanel"></div>
  <div class="sess-main">
    <div class="piano-area">
      <div class="piano-toolbar">
        <button class="oct-btn" onclick="scrollOctave(-1)">‚óÄ</button>
        <span class="view-label" id="viewLabel">C4</span>
        <button class="oct-btn" onclick="scrollOctave(1)">‚ñ∂</button>
        <span class="scroll-hint">‚Üê Ïä§ÌÅ¨Î°§Î°ú Ï†ÑÏ≤¥ 88Í±¥Î∞ò ÌÉêÏÉâ ‚Üí</span>
      </div>
      <div class="piano-scroll" id="pianoScroll">
        <div class="keyboard" id="keyboard"></div>
      </div>
    </div>
    <div class="active-notes" id="activeNotes"></div>
    <div class="chat-panel">
      <div class="chat-msgs" id="chatMsgs"></div>
      <div class="chat-row">
        <input type="text" id="chatInput" placeholder="Ï±ÑÌåÖ Î©îÏãúÏßÄ..." maxlength="200" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="btn btn-outline" onclick="sendChat()" style="padding:6px 14px;font-size:11px">Ï†ÑÏÜ°</button>
      </div>
    </div>
  </div>
</div>
</div>

<div class="modal-bg" id="pwModal">
  <div class="modal">
    <h3>üîí ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•</h3>
    <div class="field"><label>Î∞© ÎπÑÎ∞ÄÎ≤àÌò∏</label><input type="password" id="modalPw" placeholder="Password" onkeydown="if(event.key==='Enter')confirmPw()"></div>
    <div class="modal-btns">
      <button class="btn btn-primary" style="flex:1" onclick="confirmPw()">Ï∞∏Í∞Ä</button>
      <button class="btn btn-red" onclick="closePwModal()">Ï∑®ÏÜå</button>
    </div>
  </div>
</div>

<div class="color-popover" id="colorPopover">
  <div class="color-popover-title">ÎÇ¥ ÏÉâÏÉÅ Î≥ÄÍ≤Ω ‚úèÔ∏è</div>
  <div class="color-popover-swatches" id="popoverSwatches"></div>
</div>
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG (Ï£ºÏÜå ÏûêÎèô Ïó∞Îèô)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CLOUDTYPE_URL = location.origin.replace(/^http/, 'ws');

// STATE
let ws=null,myId=null,myColor='#00e5ff',myName='',currentRoomId=null,pendingJoinRoom=null;
let audioCtx=null,masterGain=null,volume=0.7;
let activeOsc=new Map(),remoteOsc=new Map();
let midiAccess=null,midiConnected=false;
let pressedLocal=new Set(),pressedRemote=new Map();
let latencyMap=new Map(),playerMap=new Map(),pingInterval=null;

const MIDI_MIN=21,MIDI_MAX=108;
const NOTE_NAMES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const IS_BLACK=[false,true,false,true,false,false,true,false,true,false,true,false];
const WKW=34,BKW=21,BKH=126,WKH=200;
const COLORS=['#00e5ff','#ff6b35','#00ff88','#a855f7','#ffcc00','#ff4466','#3b82f6','#ec4899','#f97316','#84cc16'];
let createColorSel='#00e5ff',joinColorSel='#ff6b35';

window.addEventListener('load',()=>{
  buildColorPickers();
  buildKeyboard88();
  initAudio();
  autoConnect();
  buildPopoverSwatches();
});

function autoConnect(){
  updateBanner('connecting');
  tryConnect(CLOUDTYPE_URL);
}
function tryConnect(url){
  if(ws){try{ws.close();}catch{}ws=null;}
  try{ws=new WebSocket(url);}catch{updateBanner('err','ÏûòÎ™ªÎêú ÏÑúÎ≤Ñ Ï£ºÏÜå');return;}
  ws.onopen=()=>{
    updateBanner('ok','Ïó∞Í≤∞Îê®');
    setConnStatus('ok');
    ['btnCreate','btnJoin','btnRefresh'].forEach(id=>document.getElementById(id).disabled=false);
    refreshRooms(); startPing();
  };
  ws.onclose=()=>{
    updateBanner('err','Ïó∞Í≤∞ ÎÅäÍπÄ');
    setConnStatus('err');
    ['btnCreate','btnJoin','btnRefresh'].forEach(id=>document.getElementById(id).disabled=true);
    stopPing();
    if(!currentRoomId) setTimeout(()=>tryConnect(url),4000);
  };
  ws.onmessage=e=>{let m;try{m=JSON.parse(e.data);}catch{return;}handleMsg(m);};
}
function updateBanner(state,text){
  const b=document.getElementById('serverBanner'),d=document.getElementById('bannerDot'),t=document.getElementById('bannerText');
  b.className='server-banner '+state;
  d.className='dot '+(state==='ok'?'ok':state==='err'?'err':'');
  t.textContent=text||(state==='connecting'?'ÏÑúÎ≤Ñ ÏûêÎèô Ïó∞Í≤∞ Ï§ë...':'');
}

function initAudio(){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain(); masterGain.gain.value=volume; masterGain.connect(audioCtx.destination);
}
function setVolume(v){volume=parseFloat(v);if(masterGain)masterGain.gain.value=volume;}
function midiToFreq(n){return 440*Math.pow(2,(n-69)/12);}
function playNote(note,vel=100,remote=false){
  if(!audioCtx)return; if(audioCtx.state==='suspended')audioCtx.resume();
  const f=midiToFreq(note);
  const o1=audioCtx.createOscillator(),o2=audioCtx.createOscillator();
  const g1=audioCtx.createGain(),g2=audioCtx.createGain();
  o1.type='triangle';o1.frequency.value=f;
  o2.type='sine';o2.frequency.value=f*2;g2.gain.value=0.18;
  const v2=(vel/127)*(remote?.5:.65);
  g1.gain.setValueAtTime(v2,audioCtx.currentTime);
  g1.gain.setTargetAtTime(v2*.82,audioCtx.currentTime+.02,.12);
  o1.connect(g1);o2.connect(g2);g1.connect(masterGain);g2.connect(masterGain);
  o1.start();o2.start();
  return{o1,o2,g1,g2};
}
function killNote(key,map){
  const n=map.get(key);if(!n)return;
  n.g1.gain.setTargetAtTime(0,audioCtx.currentTime,.07);
  n.g2.gain.setTargetAtTime(0,audioCtx.currentTime,.07);
  setTimeout(()=>{try{n.o1.stop();n.o2.stop();}catch{}},350);
  map.delete(key);
}

const whiteX={};
function buildKeyboard88(){
  const kb=document.getElementById('keyboard');kb.innerHTML='';let wi=0;
  for(let n=MIDI_MIN;n<=MIDI_MAX;n++){if(!IS_BLACK[n%12]){whiteX[n]=wi*WKW;wi++;}}
  kb.style.width=(wi*WKW)+'px';kb.style.height=WKH+'px';
  for(let n=MIDI_MIN;n<=MIDI_MAX;n++){
    const deg=n%12;if(IS_BLACK[deg])continue;
    const oct=Math.floor(n/12)-1;
    const el=document.createElement('div');el.className='wkey';el.dataset.note=n;
    el.style.left=whiteX[n]+'px';el.style.width=WKW+'px';el.style.height=WKH+'px';
    if(deg===0){const lb=document.createElement('div');lb.className='key-label';lb.textContent='C'+oct;el.appendChild(lb);}
    addKeyEvents(el,n);kb.appendChild(el);
  }
  for(let n=MIDI_MIN;n<=MIDI_MAX;n++){
    const deg=n%12;if(!IS_BLACK[deg])continue;
    const lx=whiteX[n-1];if(lx===undefined)continue;
    const el=document.createElement('div');el.className='bkey';el.dataset.note=n;
    el.style.left=(lx+WKW-BKW/2)+'px';el.style.width=BKW+'px';el.style.height=BKH+'px';
    addKeyEvents(el,n);kb.appendChild(el);
  }
  setTimeout(()=>scrollToNote(60),120);
}
function getKeyEl(n){return document.querySelector('[data-note="'+n+'"]');}
function setKeyVisual(note,on,isLocal,color){
  const el=getKeyEl(note);if(!el)return;
  if(isLocal){
    if(on)el.classList.add('pressed-local');else el.classList.remove('pressed-local');
  } else {
    if(on&&color){
      el.classList.add('pressed-remote');
      el.style.background='linear-gradient(180deg,'+color+' 0%,'+darken(color)+' 100%)';
      el.style.boxShadow='inset 0 3px 10px rgba(0,0,0,.35),0 0 18px '+color+'99';
    } else {
      el.classList.remove('pressed-remote');
      el.style.background='';el.style.boxShadow='';
    }
  }
}
function darken(hex){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return'rgb('+Math.floor(r*.5)+','+Math.floor(g*.5)+','+Math.floor(b*.5)+')';
}
function addKeyEvents(el,note){
  el.addEventListener('mousedown',e=>{e.preventDefault();localNoteOn(note,100);});
  el.addEventListener('mouseup',()=>localNoteOff(note));
  el.addEventListener('mouseleave',()=>{if(pressedLocal.has(note))localNoteOff(note);});
  el.addEventListener('touchstart',e=>{e.preventDefault();localNoteOn(note,100);},{passive:false});
  el.addEventListener('touchend',()=>localNoteOff(note));
}
function scrollOctave(dir){
  document.getElementById('pianoScroll').scrollBy({left:dir*7*WKW,behavior:'smooth'});
  setTimeout(updateViewLabel,300);
}
function scrollToNote(n){
  const sc=document.getElementById('pianoScroll'),el=getKeyEl(n);if(!el)return;
  sc.scrollLeft=parseInt(el.style.left)-sc.clientWidth/2+WKW/2;
  setTimeout(updateViewLabel,200);
}
function updateViewLabel(){
  const sc=document.getElementById('pianoScroll'),cx=sc.scrollLeft+sc.clientWidth/2;
  let best=MIDI_MIN,bestDist=1e9;
  for(const [n,x] of Object.entries(whiteX)){
    const d=Math.abs(x-cx);if(d<bestDist){bestDist=d;best=parseInt(n);}
  }
  document.getElementById('viewLabel').textContent=NOTE_NAMES[best%12]+(Math.floor(best/12)-1);
}
document.getElementById('pianoScroll').addEventListener('scroll',updateViewLabel);

function localNoteOn(note,vel){
  if(pressedLocal.has(note))return;
  pressedLocal.add(note);setKeyVisual(note,true,true,myColor);
  const n=playNote(note,vel,false);if(n)activeOsc.set(note,n);
  updateActiveNotes();
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'midi',data:{type:'noteOn',note,velocity:vel}}));
}
function localNoteOff(note){
  if(!pressedLocal.has(note))return;
  pressedLocal.delete(note);setKeyVisual(note,false,true,null);
  killNote(note,activeOsc);updateActiveNotes();
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'midi',data:{type:'noteOff',note}}));
}
function remoteNoteOn(note,sid,sname,scolor,vel){
  if(!pressedRemote.has(note))pressedRemote.set(note,[]);
  const list=pressedRemote.get(note);
  if(!list.find(x=>x.sid===sid))list.push({sid,color:scolor,name:sname});
  setKeyVisual(note,true,false,scolor);
  const key=sid+'_'+note;
  if(!remoteOsc.has(key)){const n=playNote(note,vel,true);if(n)remoteOsc.set(key,n);}
  updateActiveNotes();
}
function remoteNoteOff(note,sid){
  killNote(sid+'_'+note,remoteOsc);
  if(pressedRemote.has(note)){
    const list=pressedRemote.get(note).filter(x=>x.sid!==sid);
    if(list.length===0){pressedRemote.delete(note);setKeyVisual(note,false,false,null);}
    else{pressedRemote.set(note,list);setKeyVisual(note,true,false,list[list.length-1].color);}
  }
  updateActiveNotes();
}
function updateActiveNotes(){
  const el=document.getElementById('activeNotes');el.innerHTML='';
  pressedLocal.forEach(n=>{
    const t=document.createElement('div');t.className='note-tag';
    t.style.borderColor=myColor;t.style.color=myColor;
    t.textContent=NOTE_NAMES[n%12]+(Math.floor(n/12)-1);
    el.appendChild(t);
  });
  pressedRemote.forEach((list,n)=>{
    list.forEach(info=>{
      const t=document.createElement('div');t.className='note-tag';
      t.style.borderColor=info.color;t.style.color=info.color;
      t.textContent=NOTE_NAMES[n%12]+(Math.floor(n/12)-1)+' ('+info.name+')';
      el.appendChild(t);
    });
  });
}

function handleMsg(msg){
  switch(msg.type){
    case 'room_joined':
      myId=msg.clientId;currentRoomId=msg.roomId;
      document.getElementById('sessRoomId').textContent=msg.roomId;
      document.getElementById('sessRoomName').textContent=msg.roomInfo.name;
      updatePlayers(msg.roomInfo.players);showScreen('session');scrollToNote(60);
      toast('Î∞© ÏûÖÏû• ÏôÑÎ£å');break;
    case 'player_joined':
      updatePlayers(msg.roomInfo.players);
      addChat(null,msg.player.name+'ÎãòÏù¥ ÏûÖÏû•ÌñàÏäµÎãàÎã§',msg.player.color);break;
    case 'player_left':
      updatePlayers(msg.roomInfo.players);
      addChat(null,msg.playerName+'ÎãòÏù¥ Ìá¥Ïû•ÌñàÏäµÎãàÎã§','#556');
      for(const[key]of remoteOsc){if(key.startsWith(msg.playerId+'_')){remoteNoteOff(parseInt(key.split('_')[1]),msg.playerId);}}
      break;
    case 'midi':
      if(msg.data.type==='noteOn')remoteNoteOn(msg.data.note,msg.senderId,msg.senderName,msg.senderColor,msg.data.velocity);
      else if(msg.data.type==='noteOff')remoteNoteOff(msg.data.note,msg.senderId);
      break;
    case 'color_changed':
      if(playerMap.has(msg.playerId)){playerMap.get(msg.playerId).color=msg.color;renderPlayers();renderLatency();}
      break;
    case 'pong':
      const rtt=Date.now()-msg.clientTime;
      if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'latency_report',pingMs:rtt}));
      updateMyLatency(rtt);break;
    case 'latency_update':latencyMap.set(msg.playerId,msg.pingMs);renderPlayers();renderLatency();break;
    case 'room_list':renderRoomList(msg.rooms);break;
    case 'chat':addChat(msg.senderName,msg.message,msg.senderColor);break;
    case 'error':toast(msg.message,true);break;
  }
}

function createRoom(){
  if(!ws||ws.readyState!==1){toast('ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌïÑÏöî',true);return;}
  myColor=createColorSel;myName=document.getElementById('createPlayerName').value||'Host';
  ws.send(JSON.stringify({type:'create_room',name:document.getElementById('createName').value||'Room',
    password:document.getElementById('createPw').value,maxPlayers:parseInt(document.getElementById('createMax').value),
    playerName:myName,color:myColor}));
}
function joinByCode(){
  const c=document.getElementById('joinCode').value.trim().toUpperCase();
  if(!c){toast('ÏΩîÎìú ÏûÖÎ†•',true);return;}
  pendingJoinRoom={id:c,hasPassword:false};attemptJoin(c,'');
}
function joinRoom(room){
  pendingJoinRoom=room;
  if(room.hasPassword){document.getElementById('pwModal').classList.add('open');setTimeout(()=>document.getElementById('modalPw').focus(),80);}
  else attemptJoin(room.id,'');
}
function confirmPw(){const p=document.getElementById('modalPw').value;closePwModal();attemptJoin(pendingJoinRoom.id,p);}
function closePwModal(){document.getElementById('pwModal').classList.remove('open');document.getElementById('modalPw').value='';}
function attemptJoin(rid,pw){
  if(!ws||ws.readyState!==1){toast('ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌïÑÏöî',true);return;}
  myColor=joinColorSel;myName=document.getElementById('joinPlayerName').value||'Musician';
  ws.send(JSON.stringify({type:'join_room',roomId:rid,password:pw,playerName:myName,color:myColor}));
}
function leaveRoom(){
  pressedLocal.forEach(n=>localNoteOff(n));
  pressedRemote.clear();activeOsc.clear();remoteOsc.clear();updateActiveNotes();
  currentRoomId=null;myId=null;latencyMap.clear();playerMap.clear();
  setConnStatus('');showScreen('lobby');tryConnect(CLOUDTYPE_URL);
}
function refreshRooms(){if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'get_rooms'}));}
function renderRoomList(rooms){
  const el=document.getElementById('roomList');el.innerHTML='';
  if(!rooms.length){el.innerHTML='<div class="no-rooms">Í≥µÍ∞ú Î∞© ÏóÜÏùå</div>';return;}
  rooms.forEach(r=>{
    const d=document.createElement('div');d.className='room-item';
    d.innerHTML='<div><div class="room-item-name">'+escHtml(r.name)+'</div><div class="room-item-meta">'+r.id+' ¬∑ '+r.players+'/'+r.maxPlayers+'Î™Ö</div></div><div class="room-badges">'+(r.hasPassword?'<span class="badge badge-lock">üîí</span>':'')+'</div>';
    if(r.players<r.maxPlayers)d.onclick=()=>joinRoom(r);
    el.appendChild(d);
  });
}
function copyRoomId(){navigator.clipboard.writeText(document.getElementById('sessRoomId').textContent).then(()=>toast('ÏΩîÎìú Î≥µÏÇ¨ ÏôÑÎ£å'));}

function updatePlayers(players){playerMap.clear();players.forEach(p=>playerMap.set(p.id,p));renderPlayers();renderLatency();}
function renderPlayers(){
  const bar=document.getElementById('playersBar');bar.innerHTML='';
  for(const[id,p]of playerMap){
    const chip=document.createElement('div');chip.className='player-chip'+(id===myId?' mine':'');
    chip.innerHTML='<div class="player-dot" style="background:'+p.color+'"></div><span>'+escHtml(p.name)+'</span><span class="player-ping">'+(latencyMap.get(id)||0)+'ms</span>';
    if(id===myId)chip.onclick=e=>openColorPopover(e,chip);
    bar.appendChild(chip);
  }
}
function renderLatency(){
  const el=document.getElementById('latencyPanel');el.innerHTML='';
  for(const[id,p]of playerMap){
    const ms=latencyMap.get(id)||0,pct=Math.min(100,ms/3),col=ms<60?'var(--green)':ms<150?'#ffcc00':'var(--danger)';
    const item=document.createElement('div');item.className='lat-item';
    item.innerHTML='<div style="width:6px;height:6px;border-radius:50%;background:'+p.color+'"></div><div class="lat-bar"><div class="lat-fill" style="width:'+pct+'%;background:'+col+'"></div></div><span>'+ms+'ms</span>';
    el.appendChild(item);
  }
}
function updateMyLatency(ms){if(myId){latencyMap.set(myId,ms);renderPlayers();renderLatency();}}

function buildPopoverSwatches(){
  const el=document.getElementById('popoverSwatches');
  COLORS.forEach(c=>{
    const d=document.createElement('div');d.className='cswatch';d.style.background=c;
    d.onclick=()=>{changeMyColor(c);closeColorPopover();};
    el.appendChild(d);
  });
}
function openColorPopover(e,anchor){
  e.stopPropagation();const pop=document.getElementById('colorPopover'),rect=anchor.getBoundingClientRect();
  pop.style.top=(rect.bottom+8)+'px';pop.style.left=Math.min(rect.left,window.innerWidth-210)+'px';
  pop.classList.add('open');
}
function closeColorPopover(){document.getElementById('colorPopover').classList.remove('open');}
document.addEventListener('click',e=>{if(!e.target.closest('#colorPopover'))closeColorPopover();});
function changeMyColor(c){
  myColor=c;if(myId&&playerMap.has(myId))playerMap.get(myId).color=c;
  renderPlayers();renderLatency();
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'color_change',color:c}));
}

function startPing(){stopPing();pingInterval=setInterval(()=>{if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'ping',clientTime:Date.now()}));},2000);}
function stopPing(){if(pingInterval)clearInterval(pingInterval);}

async function toggleMidiInput(){
  if(midiConnected){disconnectMidi();return;}
  try{midiAccess=await navigator.requestMIDIAccess();connectMidi();}catch{toast('MIDI Í∂åÌïú ÌïÑÏöî',true);}
}
function connectMidi(){
  for(const i of midiAccess.inputs.values())i.onmidimessage=onMidiMessage;
  midiConnected=true;document.getElementById('btnMidi').className='btn btn-primary';
  document.getElementById('midiBadge').classList.add('active');toast('MIDI Ïó∞Í≤∞Îê®');
}
function disconnectMidi(){
  if(midiAccess)for(const i of midiAccess.inputs.values())i.onmidimessage=null;
  midiConnected=false;document.getElementById('btnMidi').className='btn btn-outline';
  document.getElementById('midiBadge').classList.remove('active');
}
function onMidiMessage(e){
  const[s,n,v]=e.data,cmd=s&0xf0;
  if(cmd===0x90&&v>0)localNoteOn(n,v);else if(cmd===0x80||(cmd===0x90&&v===0))localNoteOff(n);
}

function buildColorPickers(){
  [['createColors',0],['joinColors',1]].forEach(([id,i])=>{
    const el=document.getElementById(id);
    COLORS.forEach(c=>{
      const d=document.createElement('div');d.className='cswatch';d.style.background=c;
      d.onclick=()=>{el.querySelectorAll('.cswatch').forEach(s=>s.classList.remove('sel'));d.classList.add('sel');if(i===0)createColorSel=c;else joinColorSel=c;};
      el.appendChild(d);
    });
  });
}
function sendChat(){
  const i=document.getElementById('chatInput'),m=i.value.trim();if(!m)return;
  if(ws&&ws.readyState===1)ws.send(JSON.stringify({type:'chat',message:m}));i.value='';
}
function addChat(n,m,c){
  const el=document.getElementById('chatMsgs'),d=document.createElement('div');d.className='chat-msg';
  d.innerHTML=n?'<span class="cn" style="color:'+c+'">'+escHtml(n)+'</span> '+escHtml(m):'<span style="font-style:italic">'+escHtml(m)+'</span>';
  el.appendChild(d);el.scrollTop=el.scrollHeight;
}

const KB_NOTES={'a':60,'w':61,'s':62,'e':63,'d':64,'f':65,'t':66,'g':67,'y':68,'h':69,'u':70,'j':71,'k':72};
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT' || e.repeat) return;
  const n=KB_NOTES[e.key.toLowerCase()];if(n)localNoteOn(n,100);
  if(e.key==='ArrowLeft')scrollOctave(-1);if(e.key==='ArrowRight')scrollOctave(1);
});
document.addEventListener('keyup',e=>{const n=KB_NOTES[e.key.toLowerCase()];if(n)localNoteOff(n);});

function showScreen(n){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(n).classList.add('active');}
function setConnStatus(s){
  document.getElementById('connDot').className='dot '+(s==='ok'?'ok':s==='err'?'err':'');
  document.getElementById('connLabel').textContent=s==='ok'?'Ïó∞Í≤∞Îê®':s==='err'?'Ïó∞Í≤∞ ÎÅäÍπÄ':'Ïó∞Í≤∞ Ï§ë...';
}
function toast(m,e=false){
  const t=document.getElementById('toast');t.textContent=m;t.className='toast show'+(e?' error':'');
  setTimeout(()=>t.classList.remove('show'),3000);
}
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
</script>
</body>
</html>
